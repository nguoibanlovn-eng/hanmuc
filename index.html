<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Qu·∫£n l√Ω h√†ng h√≥a - B√°o c√°o L·ªó V≈©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f3f4f6;
      --bg-soft: #e5e7eb;
      --card: #ffffff;
      --card-soft: #f9fafb;
      --primary: #2563eb;
      --primary-soft: rgba(37, 99, 235, 0.12);
      --accent: #16a34a;
      --danger: #dc2626;
      --warning: #f97316;
      --muted: #6b7280;
      --border: #d1d5db;
      --text: #111827;
      --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.06);
      --radius-lg: 18px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e5f0ff, #f9fafb 55%);
      color: var(--text);
    }

    .app {
      max-width: 1280px;
      margin: 0 auto;
      padding: 16px;
    }

    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 16px;
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .app-title h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-weight: 600;
    }

    .app-title p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--card);
      color: var(--text);
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #fff;
      box-shadow: 0 12px 25px rgba(37, 99, 235, 0.35);
    }

    .btn span.icon {
      font-size: 1rem;
    }

    /* Layout ch√≠nh */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 320px);
      gap: 16px;
    }

    @media (max-width: 992px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* C·ªôt tr√°i */
    .left-column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(209, 213, 219, 0.7);
      box-shadow: var(--shadow-soft);
      padding: 12px 14px;
    }

    .filters {
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.3fr) minmax(0, 1.3fr) minmax(0, 1.5fr);
      gap: 8px;
      align-items: center;
    }

    @media (max-width: 900px) {
      .filters {
        grid-template-columns: minmax(0, 1.7fr) minmax(0, 1.3fr);
      }
    }

    @media (max-width: 640px) {
      .filters {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .field input,
    .field select {
      padding: 7px 10px;
      font-size: 0.8rem;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card-soft);
      outline: none;
    }

    .field input:focus,
    .field select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
      margin-top: 6px;
    }

    @media (max-width: 900px) {
      .summary {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .summary-card {
      padding: 10px 10px;
      border-radius: 14px;
      background: var(--card-soft);
      border: 1px solid #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .summary-card small {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .summary-card .value {
      font-size: 1.1rem;
      font-weight: 700;
    }

    .summary-card .pill {
      font-size: 0.7rem;
      color: var(--muted);
    }

    .summary-card.accent .value {
      color: var(--accent);
    }

    .summary-card.danger .value {
      color: var(--danger);
    }

    .summary-card.warning .value {
      color: var(--warning);
    }

    .summary-card.primary .value {
      color: var(--primary);
    }

    /* C√†i ƒë·∫∑t h·∫°n m·ª©c l√¥ h√†ng */
    .settings-row {
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px dashed #e5e7eb;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }

    .settings-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .settings-fields {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .settings-field {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      color: var(--muted);
    }

    .settings-field input {
      width: 60px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card-soft);
      font-size: 0.75rem;
      outline: none;
    }

    .settings-field input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.15);
    }

    .settings-field .unit {
      font-size: 0.72rem;
      color: var(--muted);
    }

    /* B·∫£ng s·∫£n ph·∫©m */
    .table-card {
      margin-top: 6px;
      padding: 10px;
    }

    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      gap: 8px;
    }

    .table-header h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .table-header small {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .chip {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
    }

    .table-wrapper {
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      overflow: auto;
      max-height: 420px;
      background: #fff;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f9fafb;
      z-index: 1;
    }

    th,
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #f1f5f9;
      white-space: nowrap;
    }

    th {
      text-align: left;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      background: #f9fafb;
      position: sticky;
      top: 0;
    }

    tr {
      cursor: pointer;
      transition: background 0.12s ease;
    }

    tbody tr:hover {
      background: #eff6ff;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .sku {
      font-weight: 600;
      color: #111827;
    }

    .product-name {
      max-width: 260px;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .tag.hot {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag.ok {
      background: #dcfce7;
      color: #166534;
    }

    .tag.slow {
      background: #fef3c7;
      color: #92400e;
    }

    .tag.brick {
      background: #e5e7eb;
      color: #374151;
    }

    .tag.low {
      background: #fef3c7;
      color: #92400e;
    }

    .tag.out {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag-plan-ahead {
      background: #dcfce7;
      color: #166534;
    }

    .tag-plan-on {
      background: #e0f2fe;
      color: #0369a1;
    }

    .tag-plan-behind {
      background: #fee2e2;
      color: #b91c1c;
    }

    .tag-plan-none {
      background: #e5e7eb;
      color: #4b5563;
    }

    .text-right {
      text-align: right;
    }

    .text-muted {
      color: var(--muted);
    }

    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 999px;
      margin-right: 4px;
    }

    .dot-hot {
      background: #dc2626;
    }

    .dot-ok {
      background: #16a34a;
    }

    .dot-slow {
      background: #f97316;
    }

    .dot-brick {
      background: #6b7280;
    }

    /* Panel chi ti·∫øt */
    .detail-card {
      position: sticky;
      top: 16px;
      min-height: 260px;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 6px;
      margin-bottom: 6px;
    }

    .detail-header h2 {
      margin: 0;
      font-size: 0.95rem;
    }

    .detail-sku {
      font-size: 0.75rem;
      color: var(--muted);
    }

    .detail-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .meta-pill {
      font-size: 0.72rem;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--card-soft);
      border: 1px dashed #e5e7eb;
    }

    .detail-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 8px;
    }

    .detail-item {
      padding: 8px 9px;
      border-radius: 10px;
      background: var(--bg-soft);
    }

    .detail-item small {
      font-size: 0.7rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-weight: 600;
    }

    .detail-item .value {
      margin-top: 3px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .detail-note {
      font-size: 0.78rem;
      color: var(--muted);
      padding: 8px 9px;
      border-radius: 10px;
      background: #eff6ff;
      border: 1px dashed #bfdbfe;
    }

    .detail-empty {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .highlight {
      font-weight: 600;
      color: var(--primary);
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="app-title">
        <h1>
          Qu·∫£n l√Ω h√†ng h√≥a
          <span class="badge">B·∫£n demo - ch∆∞a ƒë·∫•u API</span>
        </h1>
        <p>Gi√°m s√°t t·ªìn kho, t·ªëc ƒë·ªô b√°n, h·∫°n m·ª©c l√¥ h√†ng, giao vi·ªác cho c√°c team kinh doanh.</p>
      </div>
      <div class="header-actions">
        <button class="btn">
          <span class="icon">üì•</span>
          Xu·∫•t t·ªáp (CSV)
        </button>
        <button class="btn btn-primary" id="btnRefresh">
          <span class="icon">üîÑ</span>
          L√†m m·ªõi d·ªØ li·ªáu
        </button>
      </div>
    </header>

    <div class="layout">
      <!-- C·ªôt tr√°i -->
      <div class="left-column">
        <section class="card">
          <div class="filters">
            <div class="field">
              <label for="search">T√¨m SKU / t√™n</label>
              <input
                type="text"
                id="search"
                placeholder="Nh·∫≠p m√£ h√†ng ho·∫∑c t√™n s·∫£n ph·∫©m..."
              />
            </div>
            <div class="field">
              <label for="groupFilter">Nh√≥m s·∫£n ph·∫©m</label>
              <select id="groupFilter">
                <option value="">T·∫•t c·∫£ nh√≥m</option>
              </select>
            </div>
            <div class="field">
              <label for="statusFilter">Tr·∫°ng th√°i s·∫£n ph·∫©m</label>
              <select id="statusFilter">
                <option value="">T·∫•t c·∫£</option>
                <option value="HOT">B√°n ch·∫°y</option>
                <option value="OK">B√°n ƒë·ªÅu ƒë·∫∑n</option>
                <option value="SLOW">B√°n ch·∫≠m</option>
                <option value="BRICK">T·ªìn ·∫ø</option>
              </select>
            </div>
            <div class="field">
              <label for="sortBy">S·∫Øp x·∫øp</label>
              <select id="sortBy">
                <option value="name">T√™n s·∫£n ph·∫©m (A‚ÜíZ)</option>
                <option value="dohAsc">S·ªë ng√†y ƒë·ªß b√°n ‚Üë</option>
                <option value="dohDesc">S·ªë ng√†y ƒë·ªß b√°n ‚Üì</option>
                <option value="velocityDesc">T·ªëc ƒë·ªô b√°n/ng√†y ‚Üì</option>
                <option value="stockDesc">T·ªìn kho ‚Üì</option>
              </select>
            </div>
          </div>

          <div class="summary" id="summaryCards">
            <div class="summary-card primary">
              <small>T·ªïng SKU</small>
              <div class="value" id="sumSku">-</div>
              <div class="pill">ƒêang theo d√µi</div>
            </div>
            <div class="summary-card accent">
              <small>SKU d∆∞·ªõi ƒë·ªãnh m·ª©c</small>
              <div class="value" id="sumLowStock">-</div>
              <div class="pill">C·∫ßn nh·∫≠p th√™m</div>
            </div>
            <div class="summary-card warning">
              <small>SKU ch·∫≠m k·∫ø ho·∫°ch</small>
              <div class="value" id="sumSlow">-</div>
              <div class="pill">Theo h·∫°n m·ª©c l√¥ h√†ng</div>
            </div>
            <div class="summary-card danger">
              <small>S·∫£n ph·∫©m t·ªìn ·∫ø</small>
              <div class="value" id="sumBrick">-</div>
              <div class="pill">Kh√¥ng c√≥ ƒë∆°n 30 ng√†y</div>
            </div>
          </div>

          <div class="settings-row">
            <div class="settings-title">
              C√†i ƒë·∫∑t h·∫°n m·ª©c l√¥ h√†ng
            </div>
            <div class="settings-fields">
              <div class="settings-field">
                <span>Th·ªùi gian ph·∫£i b√°n h·∫øt:</span>
                <input type="number" id="targetMonthsInput" min="1" step="0.5" value="3" />
                <span class="unit">th√°ng</span>
              </div>
              <div class="settings-field">
                <span>Ng√†y an to√†n t·ªìn kho:</span>
                <input type="number" id="safetyDaysInput" min="1" step="1" value="7" />
                <span class="unit">ng√†y</span>
              </div>
            </div>
          </div>
        </section>

        <section class="card table-card">
          <div class="table-header">
            <div>
              <h2>Danh s√°ch s·∫£n ph·∫©m</h2>
              <small>
                <span id="countLabel">0</span> SKU
                <span class="chip" id="chipInfo">D·ªØ li·ªáu m·∫´u demo</span>
              </small>
            </div>
          </div>

          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>SKU</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>Nh√≥m</th>
                  <th class="text-right">T·ªìn</th>
                  <th class="text-right">B√°n 30d</th>
                  <th class="text-right">Vel/ng√†y</th>
                  <th class="text-right">Ng√†y ƒë·ªß b√°n</th>
                  <th class="text-right">DT 30d</th>
                  <th class="text-right">LN 30d</th>
                  <th class="text-right">H·∫°ng</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>K·∫ø ho·∫°ch l√¥</th>
                  <th>ƒê·ªãnh m·ª©c</th>
                </tr>
              </thead>
              <tbody id="productTableBody">
                <!-- JS render -->
              </tbody>
            </table>
          </div>
        </section>
      </div>

      <!-- C·ªôt ph·∫£i: panel chi ti·∫øt -->
      <aside class="card detail-card" id="detailPanel">
        <div class="detail-header">
          <div>
            <h2>Chi ti·∫øt s·∫£n ph·∫©m</h2>
            <div class="detail-sku" id="detailSku">
              Ch·ªçn m·ªôt d√≤ng s·∫£n ph·∫©m ·ªü b·∫£ng b√™n tr√°i ƒë·ªÉ xem chi ti·∫øt.
            </div>
          </div>
          <div id="detailStatusTag"></div>
        </div>

        <div id="detailContent">
          <p class="detail-empty">
            üëâ G·ª£i √Ω: B·∫Øt ƒë·∫ßu v·ªõi nh·ªØng SKU ƒëang c√≥
            <span class="highlight">‚ÄúS·ªë ng√†y ƒë·ªß b√°n‚Äù th·∫•p</span> ho·∫∑c
            <span class="highlight">‚ÄúD∆∞ t·ªìn & b√°n ch·∫≠m‚Äù</span> ƒë·ªÉ ∆∞u ti√™n
            quy·∫øt ƒë·ªãnh nh·∫≠p / x·∫£ h√†ng v√† giao vi·ªác cho c√°c team.
          </p>
        </div>
      </aside>
    </div>
  </div>

  <script>
    // --------------------------------------------
    // C·∫§U H√åNH NG∆Ø·ª†NG & H√ÄM TI·ªÜN √çCH
    // --------------------------------------------

    const CONFIG = {
      HOT_VELOCITY_MIN: 5,   // b√°n >= 5 sp/ng√†y coi l√† nhanh
      HOT_DOH_MAX: 10,       // d∆∞·ªõi 10 ng√†y ƒë·ªß b√°n -> nhanh
      SLOW_DOH_MIN: 30       // tr√™n 30 ng√†y ƒë·ªß b√°n -> ch·∫≠m
    };

    // Horizon giao vi·ªác (bao nhi√™u ng√†y t·ªõi)
    const PLAN_HORIZON_DAYS = 30;

    // C√°c team kinh doanh & t·ªâ tr·ªçng m·∫∑c ƒë·ªãnh
    const SALES_TEAMS = [
      { id: "facebook", label: "Facebook", weight: 0.30 },
      { id: "tiktok",   label: "TikTok",   weight: 0.30 },
      { id: "shopee",   label: "Shopee",   weight: 0.20 },
      { id: "website",  label: "Website",  weight: 0.10 },
      { id: "offline",  label: "Offline",  weight: 0.10 }
    ];

    function formatNumber(num) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return num.toLocaleString("vi-VN");
    }

    function formatFloat(num, digits = 1) {
      if (num === null || num === undefined || isNaN(num)) return "-";
      return num.toLocaleString("vi-VN", {
        minimumFractionDigits: digits,
        maximumFractionDigits: digits
      });
    }

    function classifyStatus(product) {
      const v = product.velocityPerDay || 0;
      const doh = product.doh;
      if (v === 0 && product.stock > 0) return "BRICK"; // t·ªìn ·∫ø
      if (v >= CONFIG.HOT_VELOCITY_MIN && doh !== null && doh < CONFIG.HOT_DOH_MAX) {
        return "HOT";
      }
      if (doh !== null && doh > CONFIG.SLOW_DOH_MIN) return "SLOW";
      return "OK";
    }

    function classifyStock(product) {
      const stock = product.stock;
      const min = product.minStock || 0;
      if (stock <= 0) return "OUT";
      if (stock < min) return "LOW";
      return "OK";
    }

    // --------------------------------------------
    // C·∫§U H√åNH H·∫†N M·ª®C L√î H√ÄNG (AUTO)
    // --------------------------------------------

    function getLotSettings() {
      const monthsInput = document.getElementById("targetMonthsInput");
      const safetyInput = document.getElementById("safetyDaysInput");

      const months = monthsInput ? parseFloat(monthsInput.value) : 3;
      const safetyDays = safetyInput ? parseFloat(safetyInput.value) : 7;

      const targetMonths = isNaN(months) || months <= 0 ? 3 : months;
      const safety = isNaN(safetyDays) || safetyDays <= 0 ? 7 : safetyDays;

      const targetDays = targetMonths * 30; // 1 th√°ng = 30 ng√†y
      const cycleDays = 30; // d√πng 1 th√°ng l√†m chu k·ª≥ max t·ªìn

      return { targetMonths, safetyDays: safety, targetDays, cycleDays };
    }

    function classifyPlanStatusCode(ratio) {
      if (ratio === null || ratio === undefined || isNaN(ratio) || !isFinite(ratio)) {
        return "NO_PLAN";
      }
      if (ratio >= 1.2) return "AHEAD";     // v∆∞·ª£t k·∫ø ho·∫°ch
      if (ratio >= 0.8) return "ON_TRACK";  // ti·ªám c·∫≠n k·∫ø ho·∫°ch
      return "BEHIND";                      // ch·∫≠m k·∫ø ho·∫°ch
    }

    function applyLotPlanToArray(arr) {
      const settings = getLotSettings();
      const { targetDays, safetyDays, cycleDays } = settings;

      arr.forEach(p => {
        const stock = p.stock || 0;
        const sold30 = p.sold30 || 0;

        // ∆Ø·ªöC T√çNH QUY M√î L√î: t·ªìn hi·ªán t·∫°i + l∆∞·ª£ng ƒë√£ b√°n 30 ng√†y qua
        const lotSize = stock + sold30;
        const requiredVelocity = targetDays > 0 ? (lotSize / targetDays) : 0;

        const actualVelocity = p.velocityPerDay || 0;
        const ratio = requiredVelocity > 0 ? actualVelocity / requiredVelocity : null;

        p.lotSize = lotSize;
        p.targetDays = targetDays;
        p.requiredVelocity = requiredVelocity;
        p.planRatio = ratio;
        p.planStatusCode = classifyPlanStatusCode(ratio);

        // ƒê·ªäNH M·ª®C AUTO: min = s·ªë ng√†y an to√†n, max = kho·∫£ng 1 th√°ng t·ªìn kho
        p.autoMinStock = requiredVelocity * safetyDays;
        p.autoMaxStock = requiredVelocity * cycleDays;
      });
    }

    // --------------------------------------------
    // D·ªÆ LI·ªÜU M·∫™U (DEMO)
    // --------------------------------------------

    const mockData = [
      {
        sku: "VB-PB-10000-F2",
        name: "Pin d·ª± ph√≤ng Velasboost F2 10.000mAh - S·∫°c nhanh PD 20W",
        group: "Pin d·ª± ph√≤ng",
        costPrice: 220000,
        salePrice: 329000,
        stock: 120,
        minStock: 80,
        maxStock: 200,
        sold7: 60,
        sold30: 250
      },
      {
        sku: "VB-PB-20000-TG",
        name: "Pin d·ª± ph√≤ng Velasboost Th√°nh Gi√≥ng 20.000mAh - 22.5W",
        group: "Pin d·ª± ph√≤ng",
        costPrice: 350000,
        salePrice: 489000,
        stock: 40,
        minStock: 100,
        maxStock: 250,
        sold7: 90,
        sold30: 320
      },
      {
        sku: "VB-CH-20W-TG",
        name: "C·ªß s·∫°c Velasboost Th√°nh Gi√≥ng 20W - S·∫°c nhanh nh∆∞ th·ªïi",
        group: "C·ªß s·∫°c",
        costPrice: 90000,
        salePrice: 169000,
        stock: 15,
        minStock: 50,
        maxStock: 150,
        sold7: 50,
        sold30: 210
      },
      {
        sku: "VB-CB-USB-C-1M",
        name: "C√°p s·∫°c Velasboost USB-C to USB-C 1m - H·ªó tr·ª£ PD 60W",
        group: "C√°p s·∫°c",
        costPrice: 35000,
        salePrice: 69000,
        stock: 300,
        minStock: 100,
        maxStock: 400,
        sold7: 30,
        sold30: 80
      },
      {
        sku: "VB-TWS-GACH",
        name: "Tai nghe kh√¥ng d√¢y G·∫°ch TWS - B·∫£n collab B·ª©c T∆∞·ªùng",
        group: "Tai nghe",
        costPrice: 290000,
        salePrice: 490000,
        stock: 180,
        minStock: 80,
        maxStock: 250,
        sold7: 3,
        sold30: 8
      },
      {
        sku: "VB-CB-LT-MFI",
        name: "C√°p Velasboost Lightning MFi - D√¢y b·ªán si√™u b·ªÅn",
        group: "C√°p s·∫°c",
        costPrice: 55000,
        salePrice: 99000,
        stock: 0,
        minStock: 60,
        maxStock: 180,
        sold7: 25,
        sold30: 120
      },
      {
        sku: "VB-STAND-PHONE",
        name: "Gi√° ƒë·ª° ƒëi·ªán tho·∫°i Velasboost - G·∫≠p g·ªçn, ƒë·ªÉ b√†n",
        group: "Ph·ª• ki·ªán kh√°c",
        costPrice: 20000,
        salePrice: 39000,
        stock: 260,
        minStock: 80,
        maxStock: 200,
        sold7: 2,
        sold30: 4
      }
    ];

    let products = [];
    let filteredProducts = [];
    let selectedProduct = null;

    // --------------------------------------------
    // X·ª¨ L√ù D·ªÆ LI·ªÜU & T√çNH TO√ÅN C∆† B·∫¢N
    // --------------------------------------------

    function enrichProduct(raw) {
      const sold30 = raw.sold30 || 0;
      const velocity = sold30 > 0 ? sold30 / 30 : 0;
      const stock = raw.stock || 0;
      const doh = velocity > 0 ? stock / velocity : null; // s·ªë ng√†y ƒë·ªß b√°n

      const cost = raw.costPrice || 0;
      const price = raw.salePrice || 0;
      const revenue30 = price * sold30;
      const profit30 = (price - cost) * sold30;

      const p = {
        ...raw,
        velocityPerDay: velocity,
        doh: doh,
        revenue30: revenue30,
        profit30: profit30
      };
      p.turnStatus = classifyStatus(p);
      p.stockStatus = classifyStock(p);
      return p;
    }

    function computeRankingByRevenue() {
      const sorted = [...products].sort((a, b) => {
        return (b.revenue30 || 0) - (a.revenue30 || 0);
      });
      sorted.forEach((p, index) => {
        p.rank = index + 1;
      });
    }

    // --------------------------------------------
    // RENDER SUMMARY
    // --------------------------------------------

    function renderSummary(data) {
      const totalSku = data.length;
      const lowStock = data.filter(p => p.stockStatus === "LOW" || p.stockStatus === "OUT").length;
      const behindPlan = data.filter(p => p.planStatusCode === "BEHIND").length;
      const bricks = data.filter(p => p.turnStatus === "BRICK").length;

      document.getElementById("sumSku").textContent = formatNumber(totalSku);
      document.getElementById("sumLowStock").textContent = formatNumber(lowStock);
      document.getElementById("sumSlow").textContent = formatNumber(behindPlan);
      document.getElementById("sumBrick").textContent = formatNumber(bricks);
    }

    // --------------------------------------------
    // LABELS & TAG CLASSES
    // --------------------------------------------

    function getStatusLabel(status) {
      switch (status) {
        case "HOT":   return "B√°n ch·∫°y";
        case "OK":    return "B√°n ƒë·ªÅu ƒë·∫∑n";
        case "SLOW":  return "B√°n ch·∫≠m";
        case "BRICK": return "T·ªìn ·∫ø";
        default:      return status || "-";
      }
    }

    function getStatusTagClass(status) {
      switch (status) {
        case "HOT": return "tag hot";
        case "OK": return "tag ok";
        case "SLOW": return "tag slow";
        case "BRICK": return "tag brick";
        default: return "tag";
      }
    }

    function getStockLabel(stockStatus) {
      switch (stockStatus) {
        case "LOW": return "D∆∞·ªõi min";
        case "OUT": return "H·∫øt h√†ng";
        case "OK": return "Trong ƒë·ªãnh m·ª©c";
        default: return "-";
      }
    }

    function getStockTagClass(stockStatus) {
      switch (stockStatus) {
        case "LOW": return "tag low";
        case "OUT": return "tag out";
        default: return "tag";
      }
    }

    function getPlanStatusLabel(code) {
      switch (code) {
        case "AHEAD": return "V∆∞·ª£t k·∫ø ho·∫°ch";
        case "ON_TRACK": return "ƒê√∫ng k·∫ø ho·∫°ch";
        case "BEHIND": return "Ch·∫≠m k·∫ø ho·∫°ch";
        case "NO_PLAN":
        default:
          return "Ch∆∞a t√≠nh";
      }
    }

    function getPlanStatusTagClass(code) {
      switch (code) {
        case "AHEAD": return "tag tag-plan-ahead";
        case "ON_TRACK": return "tag tag-plan-on";
        case "BEHIND": return "tag tag-plan-behind";
        case "NO_PLAN":
        default:
          return "tag tag-plan-none";
      }
    }

    // --------------------------------------------
    // RENDER TABLE
    // --------------------------------------------

    function renderTable(data) {
      const tbody = document.getElementById("productTableBody");
      tbody.innerHTML = "";

      data.forEach((p, index) => {
        const tr = document.createElement("tr");
        tr.dataset.index = index;

        const dohText = p.doh === null ? "‚Äî" : formatFloat(p.doh, 1);

        tr.innerHTML = `
          <td class="sku">${p.sku}</td>
          <td class="product-name">${p.name}</td>
          <td>${p.group || "-"}</td>
          <td class="text-right">${formatNumber(p.stock)}</td>
          <td class="text-right">${formatNumber(p.sold30)}</td>
          <td class="text-right">${formatFloat(p.velocityPerDay, 2)}</td>
          <td class="text-right">${dohText}</td>
          <td class="text-right">${formatNumber(p.revenue30)}</td>
          <td class="text-right">${formatNumber(p.profit30)}</td>
          <td class="text-right">${p.rank ? "#" + p.rank : "-"}</td>
          <td>
            <span class="${getStatusTagClass(p.turnStatus)}">
              <span class="status-dot ${
                p.turnStatus === "HOT" ? "dot-hot" :
                p.turnStatus === "OK" ? "dot-ok" :
                p.turnStatus === "SLOW" ? "dot-slow" : "dot-brick"
              }"></span>
              ${getStatusLabel(p.turnStatus)}
            </span>
          </td>
          <td>
            <span class="${getPlanStatusTagClass(p.planStatusCode)}">
              ${getPlanStatusLabel(p.planStatusCode)}
            </span>
          </td>
          <td>
            <span class="${getStockTagClass(p.stockStatus)}">
              ${getStockLabel(p.stockStatus)}
            </span>
          </td>
        `;

        tr.addEventListener("click", () => {
          selectedProduct = p;
          renderDetail(p);
        });

        tbody.appendChild(tr);
      });

      document.getElementById("countLabel").textContent = data.length.toString();
    }

    // --------------------------------------------
    // RENDER PANEL CHI TI·∫æT
    // --------------------------------------------

    function renderDetail(product) {
      if (!product) return;

      const detailSku = document.getElementById("detailSku");
      const detailStatusTag = document.getElementById("detailStatusTag");
      const detailContent = document.getElementById("detailContent");

      detailSku.textContent = `${product.sku} ¬∑ ${product.name}`;

      const statusLabel = getStatusLabel(product.turnStatus);
      const statusClass = getStatusTagClass(product.turnStatus);
      detailStatusTag.innerHTML = `
        <span class="${statusClass}">
          ${statusLabel}
        </span>
      `;

      const dohText = product.doh === null ? "Kh√¥ng x√°c ƒë·ªãnh" : `${formatFloat(product.doh, 1)} ng√†y`;
      const velocityText = `${formatFloat(product.velocityPerDay, 2)} sp/ng√†y`;

      const hasPlan = product.planStatusCode && product.planStatusCode !== "NO_PLAN";
      let planLabel = "";
      let planDesc = "";

      if (hasPlan) {
        const ratioPercent = product.planRatio != null
          ? `${Math.round(product.planRatio * 100)}%`
          : "-";

        if (product.planStatusCode === "AHEAD") {
          planLabel = "V∆∞·ª£t k·∫ø ho·∫°ch l√¥ h√†ng";
          planDesc = `T·ªëc ƒë·ªô b√°n hi·ªán t·∫°i cao h∆°n m·ª•c ti√™u (‚âà ${ratioPercent}). C√≥ th·ªÉ c√¢n nh·∫Øc tƒÉng ƒë·ªãnh m·ª©c ho·∫∑c nh·∫≠p th√™m s·ªõm.`;
        } else if (product.planStatusCode === "ON_TRACK") {
          planLabel = "ƒê√∫ng / ti·ªám c·∫≠n k·∫ø ho·∫°ch";
          planDesc = `T·ªëc ƒë·ªô b√°n ƒëang b√°m s√°t m·ª•c ti√™u (‚âà ${ratioPercent}). Theo d√µi th√™m, ch∆∞a c·∫ßn can thi·ªáp m·∫°nh.`;
        } else if (product.planStatusCode === "BEHIND") {
          planLabel = "Ch·∫≠m so v·ªõi k·∫ø ho·∫°ch";
          planDesc = `T·ªëc ƒë·ªô b√°n ƒëang th·∫•p h∆°n m·ª•c ti√™u (‚âà ${ratioPercent}). C·∫ßn xem x√©t ƒë·∫©y marketing, ƒëi·ªÅu ch·ªânh gi√° ho·∫∑c l√™n k·∫ø ho·∫°ch x·∫£.`;
        }
      } else {
        planDesc = "Ch∆∞a c√≥ k·∫ø ho·∫°ch l√¥ h√†ng r√µ, h·ªá th·ªëng ƒëang ∆∞·ªõc t√≠nh d·ª±a tr√™n t·ªìn hi·ªán t·∫°i + b√°n 30 ng√†y.";
      }

      const requiredVelocityText = product.targetDays
        ? `${formatFloat(product.requiredVelocity, 2)} sp/ng√†y trong ${formatNumber(product.targetDays)} ng√†y`
        : "Ch∆∞a thi·∫øt l·∫≠p";
      const lotSizeText = product.lotSize ? formatNumber(product.lotSize) : "‚Äî";

      let note = "";

      if (product.stockStatus === "OUT") {
        note = `S·∫£n ph·∫©m ƒë√£ <b>h·∫øt h√†ng</b> nh∆∞ng 30 ng√†y g·∫ßn ƒë√¢y v·∫´n c√≥ ƒë∆°n (${formatNumber(product.sold30)} sp). 
        N√™n ∆∞u ti√™n nh·∫≠p l·∫°i n·∫øu s·∫£n ph·∫©m c√≤n chi·∫øn l∆∞·ª£c.`;
      } else if (product.stockStatus === "LOW") {
        note = `T·ªìn kho ƒëang <b>d∆∞·ªõi ƒë·ªãnh m·ª©c</b>. ƒêang c√≥ ${formatNumber(product.stock)} sp trong khi min l√† ${formatNumber(product.minStock)}.`;
      } else if (product.turnStatus === "HOT") {
        note = `S·∫£n ph·∫©m thu·ªôc nh√≥m <b>b√°n ch·∫°y</b>: t·ªëc ƒë·ªô b√°n t·ªët (${velocityText}) v√† s·ªë ng√†y ƒë·ªß b√°n th·∫•p (${dohText}). 
        C√¢n nh·∫Øc tƒÉng t·ªìn ho·∫∑c ∆∞u ti√™n nh·∫≠p h√†ng s·ªõm.`;
      } else if (product.turnStatus === "SLOW") {
        note = `S·∫£n ph·∫©m ƒëang <b>b√°n ch·∫≠m</b>: ${velocityText}, s·ªë ng√†y ƒë·ªß b√°n cao (${dohText}). 
        C·∫ßn xem l·∫°i chi·∫øn d·ªãch ƒë·∫©y h√†ng / gi√° / g√≥i combo ho·∫∑c k·∫ø ho·∫°ch x·∫£ h√†ng.`;
      } else if (product.turnStatus === "BRICK") {
        note = `ƒê√¢y l√† s·∫£n ph·∫©m <b>t·ªìn ·∫ø</b>: 30 ng√†y g·∫ßn ƒë√¢y kh√¥ng c√≥ ƒë∆°n, nh∆∞ng v·∫´n c√≤n ${formatNumber(product.stock)} sp. 
        C·∫ßn k·∫ø ho·∫°ch x·ª≠ l√Ω: flash sale, combo, t·∫∑ng k√®m ho·∫∑c c√¢n nh·∫Øc d·ª´ng nh·∫≠p.`;
      } else {
        note = `S·∫£n ph·∫©m ƒëang <b>b√°n ƒë·ªÅu ƒë·∫∑n</b>, kh√¥ng qu√° n√≥ng c≈©ng kh√¥ng qu√° ch·∫≠m. 
        C√≥ th·ªÉ gi·ªØ ƒë·ªãnh m·ª©c hi·ªán t·∫°i v√† theo d√µi th√™m.`;
      }

      const targetMax = product.autoMaxStock || product.maxStock || 0;
      const stock = product.stock || 0;
      const suggestImport = targetMax > 0 && stock < targetMax
        ? Math.max(Math.round(targetMax - stock), 0)
        : 0;

      const autoMin = Math.round(product.autoMinStock || product.minStock || 0);
      const autoMax = Math.round(product.autoMaxStock || product.maxStock || 0);

      // ----- K·∫æ HO·∫†CH PH√ÇN B·ªî CHO C√ÅC TEAM KINH DOANH -----
      const horizonDays = Math.min(
        PLAN_HORIZON_DAYS,
        product.targetDays || PLAN_HORIZON_DAYS
      );

      const totalPlanQty = product.requiredVelocity
        ? product.requiredVelocity * horizonDays
        : 0;

      let teamPlanRows = "";
      SALES_TEAMS.forEach(team => {
        const perDay = (product.requiredVelocity || 0) * team.weight;
        const qtyHorizon = perDay * horizonDays;

        teamPlanRows += `
          <tr>
            <td style="padding:4px 4px;">${team.label}</td>
            <td style="padding:4px 4px;text-align:right;">${(team.weight * 100).toFixed(0)}%</td>
            <td style="padding:4px 4px;text-align:right;">${formatFloat(perDay, 2)}</td>
            <td style="padding:4px 4px;text-align:right;">${formatNumber(Math.round(qtyHorizon))}</td>
          </tr>
        `;
      });

      detailContent.innerHTML = `
        <div class="detail-meta">
          <span class="meta-pill">Nh√≥m: <b>${product.group || "-"}</b></span>
          <span class="meta-pill">Gi√° v·ªën: <b>${formatNumber(product.costPrice)} ƒë</b></span>
          <span class="meta-pill">Gi√° b√°n: <b>${formatNumber(product.salePrice)} ƒë</b></span>
        </div>

        <div class="detail-grid">
          <div class="detail-item">
            <small>T·ªìn kho hi·ªán t·∫°i</small>
            <div class="value">${formatNumber(product.stock)} sp</div>
          </div>
          <div class="detail-item">
            <small>ƒê·ªãnh m·ª©c (min / max)</small>
            <div class="value">${formatNumber(product.minStock)} / ${formatNumber(product.maxStock)}</div>
          </div>
          <div class="detail-item">
            <small>B√°n 7 ng√†y / 30 ng√†y</small>
            <div class="value">${formatNumber(product.sold7)} / ${formatNumber(product.sold30)} sp</div>
          </div>
          <div class="detail-item">
            <small>T·ªëc ƒë·ªô b√°n & ng√†y ƒë·ªß b√°n</small>
            <div class="value">${velocityText} ¬∑ ${dohText}</div>
          </div>
        </div>

        <div class="detail-item" style="margin-bottom:8px;">
          <small>K·∫ø ho·∫°ch l√¥ h√†ng (∆∞·ªõc t√≠nh)</small>
          <div class="value">
            L√¥ ~ ${lotSizeText} sp ¬∑ M·ª•c ti√™u ${requiredVelocityText}
          </div>
          <div style="margin-top:2px;font-size:0.75rem;color:var(--muted);">
            ${planLabel ? `<b>${planLabel}</b> ‚Äì ${planDesc}` : planDesc}
          </div>
        </div>

        <div class="detail-item" style="margin-bottom:8px;">
          <small>G·ª£i √Ω nh·∫≠p h√†ng (theo ƒë·ªãnh m·ª©c auto)</small>
          <div class="value">
            ${suggestImport > 0 ? `‚âà ${formatNumber(suggestImport)} sp` : "Ch∆∞a c·∫ßn nh·∫≠p th√™m"}
          </div>
          <div style="margin-top:2px;font-size:0.75rem;color:var(--muted);">
            ƒê·ªãnh m·ª©c g·ª£i √Ω: min ~ ${formatNumber(autoMin)} sp, max ~ ${formatNumber(autoMax)} sp.
          </div>
        </div>

        <div class="detail-item" style="margin-bottom:8px;">
          <small>K·∫ø ho·∫°ch giao vi·ªác ${horizonDays} ng√†y t·ªõi</small>
          <div style="margin-top:4px;font-size:0.8rem;">
            D·ª±a tr√™n h·∫°n m·ª©c hi·ªán t·∫°i, c·∫ßn b√°n kho·∫£ng
            <b>${formatNumber(Math.round(totalPlanQty))} sp</b>
            trong ${horizonDays} ng√†y t·ªõi ƒë·ªÉ b√°m k·∫ø ho·∫°ch. Ph√¢n b·ªï g·ª£i √Ω cho c√°c team:
          </div>
          <div style="margin-top:6px;overflow:auto;">
            <table style="width:100%;border-collapse:collapse;font-size:0.75rem;">
              <thead>
                <tr style="border-bottom:1px solid #e5e7eb;">
                  <th style="text-align:left;padding:4px 4px;">K√™nh</th>
                  <th style="text-align:right;padding:4px 4px;">T·ªâ tr·ªçng</th>
                  <th style="text-align:right;padding:4px 4px;">M·ª•c ti√™u/ng√†y</th>
                  <th style="text-align:right;padding:4px 4px;">M·ª•c ti√™u ${horizonDays} ng√†y</th>
                </tr>
              </thead>
              <tbody>
                ${teamPlanRows}
              </tbody>
            </table>
          </div>
        </div>

        <div class="detail-note">
          ${note}
        </div>
      `;
    }

    // --------------------------------------------
    // B·ªò L·ªåC + S·∫ÆP X·∫æP
    // --------------------------------------------

    function applyFilters() {
      // √°p c·∫•u h√¨nh h·∫°n m·ª©c l√¥ l√™n products
      applyLotPlanToArray(products);

      const search = document.getElementById("search").value.trim().toLowerCase();
      const groupFilter = document.getElementById("groupFilter").value;
      const statusFilter = document.getElementById("statusFilter").value;
      const sortBy = document.getElementById("sortBy").value;

      let data = [...products];

      if (search) {
        data = data.filter(p => {
          const haystack = `${p.sku} ${p.name}`.toLowerCase();
          return haystack.includes(search);
        });
      }

      if (groupFilter) {
        data = data.filter(p => p.group === groupFilter);
      }

      if (statusFilter) {
        data = data.filter(p => p.turnStatus === statusFilter);
      }

      // S·∫Øp x·∫øp
      data.sort((a, b) => {
        switch (sortBy) {
          case "name":
            return (a.name || "").localeCompare(b.name || "");
          case "dohAsc":
            return (a.doh || 999999) - (b.doh || 999999);
          case "dohDesc":
            return (b.doh || -1) - (a.doh || -1);
          case "velocityDesc":
            return (b.velocityPerDay || 0) - (a.velocityPerDay || 0);
          case "stockDesc":
            return (b.stock || 0) - (a.stock || 0);
          default:
            return 0;
        }
      });

      filteredProducts = data;
      renderSummary(data);
      renderTable(data);
    }

    function populateGroupFilter() {
      const select = document.getElementById("groupFilter");
      const groups = Array.from(new Set(products.map(p => p.group).filter(Boolean))).sort();
      while (select.options.length > 1) {
        select.remove(1);
      }
      groups.forEach(g => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        select.appendChild(opt);
      });
    }

    // --------------------------------------------
    // LOAD DATA (Apps Script / MOCK)
    // --------------------------------------------

    function loadData() {
      if (typeof google !== "undefined" &&
          google.script &&
          google.script.run) {

        google.script.run
          .withSuccessHandler(handleDataFromServer)
          .getInventoryDashboardData();

      } else {
        // m·ªü file index.html tr·ª±c ti·∫øp ƒë·ªÉ test
        handleDataFromServer(mockData);
      }
    }

    function handleDataFromServer(rawList) {
      products = rawList.map(enrichProduct);
      computeRankingByRevenue();
      populateGroupFilter();
      applyFilters();

      selectedProduct = null;
      document.getElementById("detailSku").textContent =
        "Ch·ªçn m·ªôt d√≤ng s·∫£n ph·∫©m ·ªü b·∫£ng b√™n tr√°i ƒë·ªÉ xem chi ti·∫øt.";
      document.getElementById("detailStatusTag").innerHTML = "";
      document.getElementById("detailContent").innerHTML = `
        <p class="detail-empty">
          üëâ G·ª£i √Ω: B·∫Øt ƒë·∫ßu v·ªõi nh·ªØng SKU ƒëang c√≥
          <span class="highlight">‚ÄúS·ªë ng√†y ƒë·ªß b√°n‚Äù th·∫•p</span> ho·∫∑c
          <span class="highlight">‚ÄúD∆∞ t·ªìn & b√°n ch·∫≠m‚Äù</span> ƒë·ªÉ ∆∞u ti√™n
          quy·∫øt ƒë·ªãnh nh·∫≠p / x·∫£ h√†ng v√† giao vi·ªác cho c√°c team.
        </p>
      `;
    }

    // --------------------------------------------
    // S·ª∞ KI·ªÜN
    // --------------------------------------------

    function initEvents() {
      document.getElementById("search").addEventListener("input", applyFilters);
      document.getElementById("groupFilter").addEventListener("change", applyFilters);
      document.getElementById("statusFilter").addEventListener("change", applyFilters);
      document.getElementById("sortBy").addEventListener("change", applyFilters);
      document.getElementById("btnRefresh").addEventListener("click", loadData);

      const targetMonthsInput = document.getElementById("targetMonthsInput");
      const safetyDaysInput = document.getElementById("safetyDaysInput");

      if (targetMonthsInput) {
        targetMonthsInput.addEventListener("change", applyFilters);
        targetMonthsInput.addEventListener("input", applyFilters);
      }
      if (safetyDaysInput) {
        safetyDaysInput.addEventListener("change", applyFilters);
        safetyDaysInput.addEventListener("input", applyFilters);
      }
    }

    // --------------------------------------------
    // KH·ªûI CH·∫†Y
    // --------------------------------------------

    document.addEventListener("DOMContentLoaded", () => {
      initEvents();
      loadData();
    });
  </script>
</body>
</html>
